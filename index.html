<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finodex</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
      }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background-color: #0f0f0f; }
        /* Animación para el spinner de carga */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useRef, useEffect, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Upload, FileJson, Search, ExternalLink, RefreshCw, AlertCircle, Filter, Loader2 } from 'lucide-react';

        const useFileUpload = (setCards, setError) => {
            const fileInputRef = useRef(null);
            const handleFileChange = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (Array.isArray(json)) { setCards(json); setError(null); }
                        else { setCards([json]); setError(null); }
                    } catch (err) { setError("Error al leer JSON."); }
                };
                reader.readAsText(file);
            };
            return { fileInputRef, handleFileChange };
        };

        const Card = ({ data }) => {
            const name = data["Finoler"] || "Desconocido";
            const avatarStat = data["Avatar"] || 0;
            const cunadismoStat = data["Cuñadismo"] || 0;
            const rarity = data["Rareza"] || "Común";
            const link = data["Primera Aparición"];
            const imageSrc = data["FinoCard"];
            const ratio = data["Ratio"] || "0";
            const PRIMARY_RED = '#c1272d';
            const ACCENT_YELLOW = '#ffe000';

            return (
                <div className="group relative overflow-hidden rounded-xl transition-all duration-300 hover:shadow-[0_0_20px_rgba(193,39,45,0.6)] hover:scale-105"
                     style={{ aspectRatio: '44/67', backgroundColor: '#1a1a1a', border: `2px solid ${PRIMARY_RED}` }}>
                    
                    <div className="absolute inset-0 w-full h-full bg-black">
                        {imageSrc ? (
                            <iframe 
                                src={imageSrc} 
                                className="w-full h-full pointer-events-none" 
                                frameBorder="0" 
                                title={name}
                                loading="lazy" 
                            />
                        ) : (
                            <div className="flex items-center justify-center h-full text-gray-500">Sin Imagen</div>
                        )}
                    </div>
                    
                    <div className="absolute inset-0 z-10"></div>
                    
                    <div className="absolute inset-0 bg-black/95 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-between p-4 z-20 pointer-events-none group-hover:pointer-events-auto">
                        <div className="flex justify-center mb-2">
                            <span className="px-3 py-1 text-xs font-bold uppercase rounded-full shadow-md tracking-wider"
                                  style={{ backgroundColor: PRIMARY_RED, color: ACCENT_YELLOW }}>
                                {rarity}
                            </span>
                        </div>
                        <div className="text-center border-b pb-2" style={{ borderColor: PRIMARY_RED }}>
                            <h3 className="font-bold text-xl tracking-wider truncate" style={{ color: ACCENT_YELLOW }}>{name}</h3>
                            <p className="text-xs text-gray-400 mt-1">Ratio K/D: <span className="text-white">{ratio}</span></p>
                        </div>
                        <div className="space-y-3 my-2">
                            <div>
                                <div className="flex justify-between text-xs font-bold mb-1 text-white">
                                    <span>AVATAR</span><span style={{ color: PRIMARY_RED }}>{avatarStat}</span>
                                </div>
                                <div className="w-full bg-gray-800 rounded-full h-2">
                                    <div className="h-2 rounded-full" style={{ width: `${Math.min(avatarStat, 100)}%`, backgroundColor: PRIMARY_RED }}></div>
                                </div>
                            </div>
                            <div>
                                <div className="flex justify-between text-xs font-bold mb-1 text-white">
                                    <span>CUÑADISMO</span><span style={{ color: ACCENT_YELLOW }}>{cunadismoStat}</span>
                                </div>
                                <div className="w-full bg-gray-800 rounded-full h-2">
                                    <div className="h-2 rounded-full" style={{ width: `${Math.min(cunadismoStat, 100)}%`, backgroundColor: ACCENT_YELLOW }}></div>
                                </div>
                            </div>
                        </div>
                        <div className="pt-2 border-t border-gray-800 text-center pointer-events-auto">
                            {link && (
                                <a href={link} target="_blank" rel="noopener noreferrer" className="inline-flex items-center text-xs hover:underline transition-colors" style={{ color: '#fff' }}>
                                    <ExternalLink size={12} className="mr-1" /> Primera Aparición
                                </a>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        function FinodexApp() {
            const [cards, setCards] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedRarity, setSelectedRarity] = useState(null);
            const [error, setError] = useState(null);
            
            // Estado para el scroll infinito
            const [visibleCount, setVisibleCount] = useState(12);
            // Referencia al elemento "espía" del final
            const loaderRef = useRef(null);
            
            const { fileInputRef, handleFileChange } = useFileUpload(setCards, setError);
            const PRIMARY_RED = '#c1272d';
            const ACCENT_YELLOW = '#ffe000';

            useEffect(() => {
                fetch('./cards.json')
                    .then(res => {
                        if (!res.ok) throw new Error("No se encontró cards.json");
                        return res.json();
                    })
                    .then(data => setCards(data))
                    .catch(err => console.log("Esperando archivo JSON..."));
            }, []);

            useEffect(() => {
                setVisibleCount(12);
            }, [searchTerm, selectedRarity]);

            const rarities = [...new Set(cards.map(card => card["Rareza"] || "Sin Rareza"))].sort();
            
            const filteredCards = cards.filter(card => {
                const name = card["Finoler"]?.toLowerCase() || "";
                const cardRarity = card["Rareza"] || "Sin Rareza";
                const search = searchTerm.toLowerCase();
                const matchesName = name.includes(search);
                const matchesRarity = selectedRarity ? cardRarity === selectedRarity : true;
                return matchesName && matchesRarity;
            });

            const visibleCards = filteredCards.slice(0, visibleCount);

            // LÓGICA DEL SCROLL INFINITO
            useEffect(() => {
                const observer = new IntersectionObserver((entries) => {
                    const target = entries[0];
                    if (target.isIntersecting && visibleCount < filteredCards.length) {
                        // Añadimos un pequeño delay para que se note la carga y no sea brusco
                        setTimeout(() => {
                            setVisibleCount(prev => prev + 12);
                        }, 500);
                    }
                }, {
                    root: null,
                    rootMargin: "100px", // Empieza a cargar 100px antes de llegar al final
                    threshold: 0.1
                });

                if (loaderRef.current) {
                    observer.observe(loaderRef.current);
                }

                return () => {
                    if (loaderRef.current) observer.unobserve(loaderRef.current);
                }
            }, [filteredCards, visibleCount]);

            return (
                <div className="min-h-screen font-sans text-white selection:bg-[#c1272d] selection:text-white" style={{ backgroundColor: '#0f0f0f' }}>
                    <header className="border-b border-gray-800 bg-black/50 backdrop-blur-md sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <div className="flex flex-col md:flex-row items-center justify-between gap-4 mb-4">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded flex items-center justify-center font-black text-2xl transform -skew-x-12 shadow-lg" style={{ backgroundColor: PRIMARY_RED, color: ACCENT_YELLOW }}>F</div>
                                    <h1 className="text-3xl font-extrabold tracking-tight uppercase" style={{ color: 'white' }}>Fino<span style={{ color: PRIMARY_RED }}>dex</span></h1>
                                </div>
                                <div className="relative w-full md:w-96">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><Search size={18} className="text-gray-400" /></div>
                                    <input type="text" placeholder="Buscar Finoler..." className="w-full bg-gray-900 border border-gray-700 text-white text-sm rounded-full block pl-10 p-2.5" style={{ outlineColor: PRIMARY_RED }} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                                </div>
                                <div className="hidden md:block text-xs text-gray-500">v1.3 Infinite</div>
                            </div>
                            {cards.length > 0 && (
                                <div className="flex flex-wrap gap-2 justify-center md:justify-start pt-2 border-t border-gray-800/50">
                                    <button onClick={() => setSelectedRarity(null)} className={`px-3 py-1 rounded-full text-xs font-bold uppercase border ${selectedRarity === null ? 'bg-[#ffe000] text-black border-[#ffe000]' : 'border-gray-700 text-gray-400'}`}>Todos</button>
                                    {rarities.map((rarity) => (
                                        <button key={rarity} onClick={() => setSelectedRarity(rarity === selectedRarity ? null : rarity)} className={`px-3 py-1 rounded-full text-xs font-bold uppercase border ${selectedRarity === rarity ? 'bg-[#c1272d] text-white border-[#c1272d]' : 'border-gray-700 text-gray-400'}`}>{rarity}</button>
                                    ))}
                                </div>
                            )}
                        </div>
                    </header>
                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {cards.length === 0 && (
                            <div className="text-center py-20 border-2 border-dashed border-gray-700 rounded-xl">
                                <FileJson size={48} className="mx-auto text-gray-500 mb-4" />
                                <h2 className="text-xl font-bold text-gray-300">Cargando colección...</h2>
                                <p className="text-gray-500 mb-6">Asegúrate de que 'cards.json' está en la misma carpeta.</p>
                            </div>
                        )}
                        
                        {cards.length > 0 && (
                            <>
                                <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                                    {visibleCards.map((card, index) => <Card key={index} data={card} />)}
                                </div>

                                {/* Elemento ESPÍA invisible al final para detectar el scroll */}
                                {visibleCount < filteredCards.length && (
                                    <div ref={loaderRef} className="flex justify-center items-center py-12">
                                        <div className="flex items-center gap-2 text-gray-500">
                                            <Loader2 className="spinner" size={24} />
                                            <span>Cargando más finolers...</span>
                                        </div>
                                    </div>
                                )}
                                
                                {filteredCards.length === 0 && (
                                    <div className="text-center text-gray-500 py-10">
                                        No se encontraron Finolers con esos filtros.
                                    </div>
                                )}
                            </>
                        )}
                    </main>
                    <footer className="border-t border-gray-800 mt-0 py-6 text-center text-gray-600 text-sm"><p>Finodex Generador &copy; {new Date().getFullYear()}</p></footer>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<FinodexApp />);
    </script>
</body>
</html>
